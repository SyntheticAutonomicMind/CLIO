#!/usr/bin/env perl
#
# CLIO ACP Agent Launcher
#
# Starts CLIO as an ACP-compliant agent that communicates via stdio.
# Designed to be spawned as a subprocess by ACP-compatible editors.
#
# Usage:
#   ./clio-acp-agent              # Start agent (reads stdin, writes stdout)
#   ./clio-acp-agent --debug      # Enable debug logging to stderr
#   ./clio-acp-agent --help       # Show help
#

use strict;
use warnings;
use utf8;
use FindBin;
use lib "$FindBin::Bin/lib";

use Getopt::Long;

# Parse command line options
my %opts = (
    debug => 0,
    help => 0,
);

GetOptions(
    'debug'   => \$opts{debug},
    'help|h'  => \$opts{help},
) or die "Error in command line arguments\n";

if ($opts{help}) {
    print <<'HELP';
CLIO ACP Agent

CLIO running as an ACP (Agent Client Protocol) compliant agent.
Communicates via stdio using JSON-RPC 2.0 messages.

Usage:
    ./clio-acp-agent [options]

Options:
    --debug          Enable debug output to stderr
    --help, -h       Show this help message

Protocol:
    This agent implements the Agent Client Protocol (ACP) specification.
    Messages are JSON-RPC 2.0, newline-delimited, over stdin/stdout.

Methods:
    initialize       - Negotiate version and capabilities
    session/new      - Create a new conversation session
    session/load     - Resume an existing session
    session/prompt   - Send a user prompt

Notifications:
    session/cancel   - Cancel ongoing operations
    session/update   - (sent by agent) Stream updates to client

Example Client Integration:
    The editor spawns this process and communicates via stdio:
    
    --> {"jsonrpc":"2.0","id":0,"method":"initialize","params":{"protocolVersion":1}}
    <-- {"jsonrpc":"2.0","id":0,"result":{"protocolVersion":1,"agentCapabilities":{}}}
    
    --> {"jsonrpc":"2.0","id":1,"method":"session/new","params":{"cwd":"/project"}}
    <-- {"jsonrpc":"2.0","id":1,"result":{"sessionId":"sess_abc123"}}
    
    --> {"jsonrpc":"2.0","id":2,"method":"session/prompt","params":{...}}
    <-- {"jsonrpc":"2.0","method":"session/update","params":{...}}
    <-- {"jsonrpc":"2.0","id":2,"result":{"stopReason":"end_turn"}}

HELP
    exit 0;
}

# Load CLIO config
my $config;
eval {
    require CLIO::Core::Config;
    $config = CLIO::Core::Config->new(debug => $opts{debug});
};
if ($@) {
    print STDERR "[ACP] Warning: Could not load config: $@\n" if $opts{debug};
}

# Load agent module
require CLIO::ACP::Agent;

# Create and run agent
my $agent = CLIO::ACP::Agent->new(
    config => $config,
    debug => $opts{debug},
);

$agent->run();

name: PR Review with CLIO

# Trigger on PR events
on:
  pull_request:
    types: [opened, synchronize, reopened, review_requested]

permissions:
  pull-requests: write
  contents: read
  packages: read

env:
  CLIO_MODEL: gpt-5-mini
  REGISTRY: ghcr.io

jobs:
  review:
    name: Analyze and Review PR
    runs-on: ubuntu-latest
    
    if: |
      github.event.pull_request.user.type != 'Bot' &&
      github.event.pull_request.draft != true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull CLIO container
        run: docker pull ghcr.io/syntheticautonomicmind/clio:latest
      
      - name: Prepare workspace
        run: |
          mkdir -p /tmp/clio-workspace
          cp -r ./* /tmp/clio-workspace/ 2>/dev/null || true
          cp -r ./.clio /tmp/clio-workspace/ 2>/dev/null || true
          cp -r ./.github /tmp/clio-workspace/ 2>/dev/null || true
          mkdir -p /tmp/clio-workspace/.clio/sessions
          mkdir -p /tmp/clio-config
      
      - name: Configure CLIO authentication
        env:
          CLIO_ACCESS: ${{ secrets.CLIO_ACCESS }}
        run: |
          set +x
          printf '{"github_token": "%s", "saved_at": %d}' "$CLIO_ACCESS" "$(date +%s)" > /tmp/clio-config/github_tokens.json
          chmod 600 /tmp/clio-config/github_tokens.json
          echo '{"provider": "github_copilot"}' > /tmp/clio-config/config.json
      
      - name: Prepare PR info file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Fetch PR diff and save to workspace
          gh pr diff $PR_NUMBER > /tmp/clio-workspace/PR_DIFF.txt 2>/dev/null || echo "No diff available" > /tmp/clio-workspace/PR_DIFF.txt
          
          # Fetch changed files
          gh pr view $PR_NUMBER --json files --jq '.files[].path' > /tmp/clio-workspace/PR_FILES.txt 2>/dev/null || echo "" > /tmp/clio-workspace/PR_FILES.txt
          
          # Create PR info file
          cat > /tmp/clio-workspace/PR_INFO.md << EOF
          # Pull Request #${PR_NUMBER}
          
          **Title:** ${{ github.event.pull_request.title }}
          **Author:** ${{ github.event.pull_request.user.login }}
          **Branch:** ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}
          **Event:** ${{ github.event.action }}
          
          ## Description
          
          ${{ github.event.pull_request.body }}
          
          ## Changed Files
          
          See PR_FILES.txt
          
          ## Diff
          
          See PR_DIFF.txt
          EOF
          
          echo "PR info prepared"
          wc -l /tmp/clio-workspace/PR_DIFF.txt
          wc -l /tmp/clio-workspace/PR_FILES.txt
      
      - name: Run CLIO PR Review
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Build the task for CLIO
          TASK="You are in HEADLESS CI/CD MODE. No human is present - do not use user_collaboration or it will hang forever.

          TASK: Review Pull Request #${PR_NUMBER}

          STEPS:
          1. Read .github/clio-prompts/pr-review.md for review instructions
          2. Read PR_INFO.md for PR details
          3. Read PR_DIFF.txt for the code diff
          4. Read PR_FILES.txt to see changed files
          5. If needed, read relevant project files (AGENTS.md, docs/STYLE_GUIDE.md)
          6. Output your review as a JSON object

          CRITICAL: Output ONLY a JSON object at the end. No prose. No questions. No user_collaboration."
          
          echo "=== Starting CLIO PR Review ==="
          echo "Task: Review PR #${PR_NUMBER}"
          echo ""
          
          # Run CLIO with the task as --input
          docker run -i --rm \
            -v "/tmp/clio-workspace":/workspace:rw \
            -v "/tmp/clio-config":/root/.clio:rw \
            -w /workspace \
            -e CLIO_LOG_LEVEL=INFO \
            -e GH_TOKEN="${GH_TOKEN}" \
            ghcr.io/syntheticautonomicmind/clio:latest \
            --new \
            --model "$CLIO_MODEL" \
            --input "$TASK" \
            --exit 2>&1 | tee /tmp/clio-workspace/full_response.txt || true
          
          echo ""
          echo "=== CLIO Review Complete ==="
          echo "Response size: $(wc -c < /tmp/clio-workspace/full_response.txt) bytes"
      
      - name: Extract JSON from response
        id: extract
        run: |
          # Create Python script for JSON extraction
          cat > /tmp/extract_json.py << 'PYEOF'
          import sys, json, re
          
          with open('/tmp/clio-workspace/full_response.txt', 'r') as f:
              content = f.read()
          
          # Try to find JSON between ```json and ```
          match = re.search(r'```json\s*(.*?)\s*```', content, re.DOTALL)
          if match:
              try:
                  obj = json.loads(match.group(1))
                  print(json.dumps(obj))
                  sys.exit(0)
              except:
                  pass
          
          # Try to find raw JSON with expected keys
          for i in range(len(content)):
              if content[i] == '{':
                  depth = 0
                  for j in range(i, len(content)):
                      if content[j] == '{': depth += 1
                      elif content[j] == '}': depth -= 1
                      if depth == 0:
                          try:
                              obj = json.loads(content[i:j+1])
                              if 'recommendation' in obj or 'summary' in obj:
                                  print(json.dumps(obj))
                                  sys.exit(0)
                          except:
                              pass
                          break
          print("")
          PYEOF
          
          JSON_RESPONSE=$(python3 /tmp/extract_json.py) || true
          
          if [ -n "$JSON_RESPONSE" ] && echo "$JSON_RESPONSE" | jq . > /dev/null 2>&1; then
            echo "$JSON_RESPONSE" > /tmp/clio-workspace/analysis.json
            echo "json_valid=true" >> $GITHUB_OUTPUT
          else
            cat > /tmp/clio-workspace/analysis.json << 'FALLBACK_EOF'
          {
            "recommendation": "needs-review",
            "security_concerns": [],
            "style_issues": [],
            "documentation_issues": [],
            "test_coverage": "unknown",
            "breaking_changes": false,
            "suggested_labels": ["needs-review"],
            "summary": "Automated analysis could not parse response. Manual review recommended.",
            "detailed_feedback": []
          }
          FALLBACK_EOF
            echo "json_valid=false" >> $GITHUB_OUTPUT
          fi
          
          echo "=== Extracted JSON ==="
          cat /tmp/clio-workspace/analysis.json
      
      - name: Parse results
        id: parse
        run: |
          ANALYSIS_JSON=$(cat /tmp/clio-workspace/analysis.json)
          
          RECOMMENDATION=$(echo "$ANALYSIS_JSON" | jq -r '.recommendation // "needs-review"')
          SUMMARY=$(echo "$ANALYSIS_JSON" | jq -r '.summary // "Analysis complete."')
          BREAKING_CHANGES=$(echo "$ANALYSIS_JSON" | jq -r '.breaking_changes // false')
          TEST_COVERAGE=$(echo "$ANALYSIS_JSON" | jq -r '.test_coverage // "unknown"')
          
          SECURITY_CONCERNS=$(echo "$ANALYSIS_JSON" | jq -r 'if .security_concerns and (.security_concerns | length) > 0 then (.security_concerns | map("- âš ï¸ " + .) | join("\n")) else "" end')
          STYLE_ISSUES=$(echo "$ANALYSIS_JSON" | jq -r 'if .style_issues and (.style_issues | length) > 0 then (.style_issues | map("- ðŸ“ " + .) | join("\n")) else "" end')
          DOC_ISSUES=$(echo "$ANALYSIS_JSON" | jq -r 'if .documentation_issues and (.documentation_issues | length) > 0 then (.documentation_issues | map("- ðŸ“š " + .) | join("\n")) else "" end')
          DETAILED_FEEDBACK=$(echo "$ANALYSIS_JSON" | jq -r 'if .detailed_feedback and (.detailed_feedback | length) > 0 then (.detailed_feedback | map("- " + .) | join("\n")) else "" end')
          
          SUGGESTED_LABELS=$(echo "$ANALYSIS_JSON" | jq -r '(.labels // .suggested_labels // []) | join(",")')
          
          SECURITY_COUNT=$(echo "$ANALYSIS_JSON" | jq -r '(.security_concerns // []) | length')
          STYLE_COUNT=$(echo "$ANALYSIS_JSON" | jq -r '(.style_issues // []) | length')
          DOC_COUNT=$(echo "$ANALYSIS_JSON" | jq -r '(.documentation_issues // []) | length')
          
          {
            echo "recommendation=$RECOMMENDATION"
            echo "breaking_changes=$BREAKING_CHANGES"
            echo "test_coverage=$TEST_COVERAGE"
            echo "security_count=$SECURITY_COUNT"
            echo "style_count=$STYLE_COUNT"
            echo "doc_count=$DOC_COUNT"
            
            echo "suggested_labels<<LABELS_EOF"
            echo "$SUGGESTED_LABELS"
            echo "LABELS_EOF"
            
            echo "summary<<SUMMARY_EOF"
            echo "$SUMMARY"
            echo "SUMMARY_EOF"
            
            echo "security_concerns<<SECURITY_EOF"
            echo "$SECURITY_CONCERNS"
            echo "SECURITY_EOF"
            
            echo "style_issues<<STYLE_EOF"
            echo "$STYLE_ISSUES"
            echo "STYLE_EOF"
            
            echo "doc_issues<<DOC_EOF"
            echo "$DOC_ISSUES"
            echo "DOC_EOF"
            
            echo "detailed_feedback<<FEEDBACK_EOF"
            echo "$DETAILED_FEEDBACK"
            echo "FEEDBACK_EOF"
          } >> $GITHUB_OUTPUT
      
      - name: Apply labels
        if: steps.parse.outputs.suggested_labels != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          declare -A LABEL_COLORS
          LABEL_COLORS["needs-review"]="fbca04"
          LABEL_COLORS["needs-changes"]="d93f0b"
          LABEL_COLORS["security-concern"]="b60205"
          LABEL_COLORS["approved"]="0e8a16"
          LABEL_COLORS["breaking-change"]="d73a4a"
          LABEL_COLORS["needs-tests"]="d876e3"
          LABEL_COLORS["needs-docs"]="0075ca"
          LABEL_COLORS["style-issues"]="c5def5"
          LABEL_COLORS["area:core"]="c5def5"
          LABEL_COLORS["area:tools"]="c5def5"
          LABEL_COLORS["area:ui"]="c5def5"
          
          IFS=',' read -ra LABELS <<< "${{ steps.parse.outputs.suggested_labels }}"
          for label in "${LABELS[@]}"; do
            label=$(echo "$label" | xargs)
            if [ -n "$label" ]; then
              if ! gh pr edit ${{ github.event.pull_request.number }} --add-label "$label" 2>/dev/null; then
                COLOR="${LABEL_COLORS[$label]:-c5def5}"
                gh label create "$label" --color "$COLOR" 2>/dev/null || true
                gh pr edit ${{ github.event.pull_request.number }} --add-label "$label" 2>/dev/null || true
              fi
            fi
          done
      
      - name: Post review comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          case "${{ steps.parse.outputs.recommendation }}" in
            "approve"|"approved") EMOJI="âœ…"; VERDICT="LGTM - Ready for Human Review" ;;
            "needs-changes") EMOJI="âš ï¸"; VERDICT="Changes Requested" ;;
            "security-concern") EMOJI="ðŸ”’"; VERDICT="Security Review Required" ;;
            *) EMOJI="ðŸ‘€"; VERDICT="Needs Human Review" ;;
          esac
          
          cat > /tmp/clio-workspace/comment.md << COMMENT_EOF
          ## ${EMOJI} CLIO PR Review
          
          | Field | Value |
          |-------|-------|
          | **Recommendation** | ${VERDICT} |
          | **Test Coverage** | ${{ steps.parse.outputs.test_coverage }} |
          | **Breaking Changes** | ${{ steps.parse.outputs.breaking_changes }} |
          
          ### ðŸ“‹ Summary
          ${{ steps.parse.outputs.summary }}
          COMMENT_EOF
          
          SECURITY="${{ steps.parse.outputs.security_concerns }}"
          if [ -n "$SECURITY" ] && [ "${{ steps.parse.outputs.security_count }}" -gt 0 ]; then
            echo "" >> /tmp/clio-workspace/comment.md
            echo "### ðŸ”’ Security Concerns" >> /tmp/clio-workspace/comment.md
            echo "$SECURITY" >> /tmp/clio-workspace/comment.md
          fi
          
          STYLE="${{ steps.parse.outputs.style_issues }}"
          if [ -n "$STYLE" ] && [ "${{ steps.parse.outputs.style_count }}" -gt 0 ]; then
            echo "" >> /tmp/clio-workspace/comment.md
            echo "### ðŸ“ Style Issues" >> /tmp/clio-workspace/comment.md
            echo "$STYLE" >> /tmp/clio-workspace/comment.md
          fi
          
          DOCS="${{ steps.parse.outputs.doc_issues }}"
          if [ -n "$DOCS" ] && [ "${{ steps.parse.outputs.doc_count }}" -gt 0 ]; then
            echo "" >> /tmp/clio-workspace/comment.md
            echo "### ðŸ“š Documentation Issues" >> /tmp/clio-workspace/comment.md
            echo "$DOCS" >> /tmp/clio-workspace/comment.md
          fi
          
          FEEDBACK="${{ steps.parse.outputs.detailed_feedback }}"
          if [ -n "$FEEDBACK" ]; then
            echo "" >> /tmp/clio-workspace/comment.md
            echo "### ðŸ’¡ Feedback" >> /tmp/clio-workspace/comment.md
            echo "$FEEDBACK" >> /tmp/clio-workspace/comment.md
          fi
          
          echo "" >> /tmp/clio-workspace/comment.md
          echo "---" >> /tmp/clio-workspace/comment.md
          echo "*Automated review by [CLIO](https://github.com/SyntheticAutonomicMind/CLIO)*" >> /tmp/clio-workspace/comment.md
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/clio-workspace/comment.md
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clio-pr-review-${{ github.event.pull_request.number }}-${{ github.run_number }}
          path: /tmp/clio-workspace/
          retention-days: 7
